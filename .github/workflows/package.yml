name: Package Plugin

on:
  workflow_dispatch:
    inputs:
      use_dify_cli:
        description: "Use official dify CLI to package"
        required: false
        type: boolean
        default: true
      install_dify_cli_command:
        description: "Command to install dify CLI (optional; leave empty if already installed)"
        required: false
        type: string
        default: ""
  push:
    tags:
      - "v*"

jobs:
  pack_zip:
    name: Fallback ZIP (dev_cli)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate manifest
        run: |
          python scripts/dev_cli.py validate

      - name: Pack (fallback zip)
        run: |
          python scripts/dev_cli.py pack

      - name: Upload artifact (fallback zip)
        uses: actions/upload-artifact@v4
        with:
          name: plugin-fallback-zip
          path: |
            dist/**
          if-no-files-found: warn

  dify_package:
    name: Package with dify CLI
    runs-on: ubuntu-latest
    needs: pack_zip
    if: ${{ github.event_name == 'push' || inputs.use_dify_cli == true }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Optionally install dify CLI
        if: ${{ inputs.install_dify_cli_command != '' }}
        run: |
          echo "+ Installing dify CLI with provided command"
          set -eux
          ${INPUT_INSTALL_CMD}
        env:
          INPUT_INSTALL_CMD: ${{ inputs.install_dify_cli_command }}

      - name: Check dify CLI availability
        id: check_dify
        run: |
          if command -v dify >/dev/null 2>&1; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Package with dify CLI
        if: steps.check_dify.outputs.found == 'true'
        run: |
          set -eux
          dify plugin package .

      - name: Upload artifact (dify outputs and dist)
        if: steps.check_dify.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: plugin-dify-package
          path: |
            dist/**
            *.zip
            *.dify*
            release/**
          if-no-files-found: warn

      - name: Note when dify CLI is missing
        if: steps.check_dify.outputs.found != 'true'
        run: |
          echo "dify CLI が見つかりません。'install_dify_cli_command' を指定するか、Runner にプリインストールしてください。"
          echo "fallback ZIP は 'plugin-fallback-zip' アーティファクトとして取得できます。"

